<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Music Web App</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.youtube.com/iframe_api"></script>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center min-h-screen p-4">
  <div class="w-full max-w-2xl flex flex-col gap-4">
    <div id="errorContainer" class="hidden opacity-0 bg-red-600 p-2 rounded-md flex justify-between items-center transition-opacity duration-300">
      <span id="errorMessage"></span>
      <button id="dismissError">
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
          <path d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"/>
        </svg>
      </button>
    </div>
    <div class="flex">
      <input id="unifiedInput" type="text" placeholder="Enter YouTube URL or search music..." class="w-full p-2 bg-gray-800 border border-gray-700 rounded-l-md focus:outline-none focus:ring-2 focus:ring-teal-500"/>
      <button id="unifiedBtn" class="px-4 py-2 bg-teal-600 hover:bg-teal-700 rounded-r-md">Go</button>
    </div>
    <div id="player" class="w-full aspect-video bg-gray-800 rounded-md"></div>
    <div class="flex justify-between text-sm">
      <span id="currentTime">0:00</span>
      <span id="duration">0:00</span>
    </div>
    <div id="progressContainer" class="w-full h-2 bg-gray-600 rounded cursor-pointer">
      <div id="progressBar" class="h-full bg-green-500 rounded" style="width:0%"></div>
    </div>
    <div class="flex justify-center gap-4">
      <button id="prevBtn" class="p-2 bg-gray-700 hover:bg-gray-600 rounded-full">
        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
      </button>
      <button id="playPauseBtn" class="p-2 bg-green-600 hover:bg-green-700 rounded-full">
        <svg id="playIcon" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
        <svg id="pauseIcon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
      </button>
      <button id="nextBtn" class="p-2 bg-gray-700 hover:bg-gray-600 rounded-full">
        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M18 6h-2v12h2zm-3.5 6l-8.5 6V6z"/></svg>
      </button>
    </div>
    <div class="max-h-96 overflow-y-auto bg-gray-800 rounded-md">
      <ul id="searchResults" class="divide-y divide-gray-700"></ul>
    </div>
  </div>
  <script>
    const API_KEY = 'AIzaSyBRf3iFOHJHzoc3KzaGne0jvfi8Ez2sncE';
    let player, playlist = [], currentIndex = -1, progressInterval;

    const elements = {
      errorContainer: document.getElementById('errorContainer'),
      errorMessage: document.getElementById('errorMessage'),
      unifiedInput: document.getElementById('unifiedInput'),
      playIcon: document.getElementById('playIcon'),
      pauseIcon: document.getElementById('pauseIcon'),
      currentTime: document.getElementById('currentTime'),
      duration: document.getElementById('duration'),
      progressBar: document.getElementById('progressBar'),
      searchResults: document.getElementById('searchResults')
    };

    const errors = {
      emptyInput: 'Please enter a YouTube URL or search query.',
      invalidURL: 'Invalid YouTube URL. Please provide a valid video link.',
      noAPIKey: 'Search requires a valid YouTube Data API key.',
      noResults: 'No search results found.',
      quota: 'API quota exceeded. Please try again later.',
      apiKey: 'Invalid or missing API key for search.',
      network: 'Network error. Please check your connection.',
      player: {
        2: 'Invalid video ID.',
        5: 'Video cannot be played (player error).',
        100: 'Video not found or removed.',
        101: 'Video is restricted or not playable.',
        150: 'Video is restricted or not playable.'
      }
    };

    const showError = (message) => {
      elements.errorMessage.textContent = message;
      elements.errorContainer.classList.remove('hidden', 'opacity-0');
      elements.errorContainer.classList.add('opacity-100');
      setTimeout(hideError, 5000);
    };

    const hideError = () => {
      elements.errorContainer.classList.add('opacity-0');
      setTimeout(() => elements.errorContainer.classList.add('hidden'), 300);
    };

    const parseYouTubeURL = (input) => input.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/i)?.[1];

    const isYouTubeURL = (input) => /youtube\.com|youtu\.be/.test(input);

    const formatTime = (seconds) => {
      const m = Math.floor(seconds / 60), s = Math.floor(seconds % 60);
      return `${m}:${s < 10 ? '0' : ''}${s}`;
    };

    const updateProgress = () => {
      const current = player.getCurrentTime(), duration = player.getDuration();
      elements.progressBar.style.width = `${(current / duration) * 100}%`;
      elements.currentTime.textContent = formatTime(current);
      elements.duration.textContent = formatTime(duration);
    };

    const startProgress = () => {
      clearInterval(progressInterval);
      progressInterval = setInterval(updateProgress, 1000);
    };

    const stopProgress = () => clearInterval(progressInterval);

    const loadVideo = (videoId) => {
      playlist.push({ id: videoId, title: 'Video from URL', thumbnail: `https://img.youtube.com/vi/${videoId}/mqdefault.jpg` });
      renderPlaylist();
      elements.unifiedInput.value = '';
    };

    const searchVideos = async (query) => {
      if (!API_KEY || API_KEY === 'YOUR_API_KEY') return showError(errors.noAPIKey);
      try {
        const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(query)}&maxResults=30&type=video&key=${API_KEY}`);
        if (!res.ok) throw new Error((await res.json()).error.message);
        const { items } = await res.json();
        if (!items.length) return showError(errors.noResults);
        playlist = items.map(({ id: { videoId }, snippet: { title, thumbnails } }) => ({
          id: videoId,
          title,
          thumbnail: thumbnails.medium.url
        }));
        currentIndex = -1;
        renderPlaylist();
        elements.unifiedInput.value = '';
      } catch (e) {
        showError(e.message.includes('quota') ? errors.quota : e.message.includes('API key') ? errors.apiKey : errors.network);
      }
    };

    const handleInput = (input) => {
      if (!input) return showError(errors.emptyInput);
      const videoId = parseYouTubeURL(input);
      if (isYouTubeURL(input) && videoId) loadVideo(videoId);
      else searchVideos(input);
    };

    const renderPlaylist = () => {
      elements.searchResults.innerHTML = playlist.map((item, i) => `
        <li class="p-2 cursor-pointer flex items-center gap-2 hover:bg-gray-700 ${i === currentIndex ? 'text-green-500' : ''}" data-index="${i}">
          <img src="${item.thumbnail}" alt="Thumbnail" class="w-16 h-9 object-cover rounded">
          <span class="truncate">${item.title}</span>
        </li>
      `).join('');
    };

    const playSong = (index) => {
      if (index < 0 || index >= playlist.length) return;
      currentIndex = index;
      player.loadVideoById(playlist[index].id);
      renderPlaylist();
    };

    const togglePlayPause = () => {
      const state = player.getPlayerState();
      state === YT.PlayerState.PLAYING ? player.pauseVideo() : player.playVideo();
    };

    const playPrev = () => currentIndex > 0 && playSong(currentIndex - 1);
    const playNext = () => currentIndex < playlist.length - 1 && playSong(currentIndex + 1);

    window.onYouTubeIframeAPIReady = () => {
      player = new YT.Player('player', {
        height: '100%',
        width: '100%',
        events: {
          onReady: () => startProgress(),
          onStateChange: ({ data }) => {
            elements.playIcon.classList.toggle('hidden', data === YT.PlayerState.PLAYING);
            elements.pauseIcon.classList.toggle('hidden', data !== YT.PlayerState.PLAYING);
            data === YT.PlayerState.PLAYING ? startProgress() : stopProgress();
            if (data === YT.PlayerState.ENDED && currentIndex < playlist.length - 1) playNext();
          },
          onError: ({ data }) => showError(errors.player[data] || 'Video playback error.')
        }
      });
    };

    document.addEventListener('click', ({ target }) => {
      hideError();
      if (target.closest('#dismissError')) return hideError();
      if (target.closest('#unifiedBtn')) return handleInput(elements.unifiedInput.value.trim());
      if (target.closest('#prevBtn')) return playPrev();
      if (target.closest('#nextBtn')) return playNext();
      if (target.closest('#playPauseBtn')) return togglePlayPause();
      if (target.closest('#progressContainer')) {
        const { left, width } = target.closest('#progressContainer').getBoundingClientRect();
        player.seekTo((event.clientX - left) / width * player.getDuration(), true);
      }
      if (target.closest('li[data-index]')) playSong(+target.closest('li').dataset.index);
    });

    document.addEventListener('keypress', (e) => {
      if (e.key !== 'Enter' || e.target.id !== 'unifiedInput') return;
      handleInput(elements.unifiedInput.value.trim());
    });

    document.addEventListener('keydown', (e) => {
      if (e.target.tagName === 'INPUT') return;
      const key = e.key;
      if (['MediaTrackPrevious', 'ArrowLeft'].includes(key)) {
        e.preventDefault();
        playPrev();
      } else if (['MediaPlayPause', ' '].includes(key)) {
        e.preventDefault();
        togglePlayPause();
      } else if (['MediaTrackNext', 'ArrowRight'].includes(key)) {
        e.preventDefault();
        playNext();
      }
    });
  </script>
</body>
</html>
