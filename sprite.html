<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sprite Sheet Generator</title>
<style>
  body {
    font-family: sans-serif;
    margin: 20px;
    background: #f9f9f9;
  }
  input, button {
    margin: 10px 5px 10px 0;
  }
  #preview {
    margin-top: 20px;
    border: 1px solid #ccc;
    display: block;
    max-width: 100%;
  }
  #jsonOutput {
    margin-top: 20px;
    white-space: pre-wrap;
    background: #eee;
    padding: 10px;
    border-radius: 5px;
    max-height: 300px;
    overflow: auto;
  }
</style>
</head>
<body>

<h1>Sprite Sheet Generator</h1>

<input type="file" id="fileInput" multiple accept="image/*">
<br>
<button id="downloadImage">Download Sprite Sheet PNG</button>
<button id="downloadJSON">Download JSON</button>

<canvas id="preview"></canvas>
<pre id="jsonOutput"></pre>

<script>
const fileInput = document.getElementById('fileInput');
const previewCanvas = document.getElementById('preview');
const ctx = previewCanvas.getContext('2d');
const jsonOutput = document.getElementById('jsonOutput');
let spriteData = {};
let spriteBlob = null;

// Convert canvas → Blob
function canvasToBlob(canvas) {
  return new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
}

async function generateSprite(files) {
  if (!files.length) return;

  const images = [];
  // Load tất cả ảnh
  for (const file of files) {
    if (!file.type.startsWith('image/')) continue;
    const img = new Image();
    img.src = URL.createObjectURL(file);
    await new Promise(res => img.onload = res);
    images.push({ name: file.name, img });
  }

  if (!images.length) return;

  // Xác định kích thước tổng
  const maxWidth = Math.max(...images.map(i => i.img.width));
  const totalHeight = images.reduce((sum, i) => sum + i.img.height, 0);

  previewCanvas.width = maxWidth;
  previewCanvas.height = totalHeight;

  ctx.clearRect(0, 0, maxWidth, totalHeight);

  let y = 0;
  spriteData = {};

  for (const { name, img } of images) {
    const x = (maxWidth - img.width) / 2;
    ctx.drawImage(img, x, y);

    spriteData[name] = {
      x: Math.round(x),
      y: Math.round(y),
      width: img.width,
      height: img.height
    };
    y += img.height;
  }

  jsonOutput.textContent = JSON.stringify(spriteData, null, 2);

  // Tạo blob lưu tạm cho download
  spriteBlob = await canvasToBlob(previewCanvas);
}

// Upload
fileInput.addEventListener('change', e => generateSprite(e.target.files));

// Download PNG
document.getElementById('downloadImage').addEventListener('click', () => {
  if (!spriteBlob) return alert('Chưa có sprite sheet, hãy upload ảnh trước.');
  const url = URL.createObjectURL(spriteBlob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'sprite-sheet.png';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
});

// Download JSON
document.getElementById('downloadJSON').addEventListener('click', () => {
  if (!Object.keys(spriteData).length) return alert('Chưa có dữ liệu JSON.');
  const blob = new Blob([JSON.stringify(spriteData, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'sprite-sheet.json';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
});
</script>

</body>
</html>
