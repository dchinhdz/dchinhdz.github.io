<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sprite Editor</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<nav>
  <a href="sprite.html">Sprite Maker</a>
  <a href="editor.html" class="active">Sprite Editor</a>
</nav>

<header>ðŸŽ¨ Sprite Editor</header>
<main>
  <input type="file" id="fileInput" multiple accept="image/*">
  <div id="canvasWrap"><canvas id="canvas"></canvas></div>

  <div class="controls-top">
    <button id="autoTrim">Auto Trim</button>
    <button id="refresh">Reset Layout</button>
    <button id="download">Download</button>
  </div>

  <div id="controls"></div>
</main>

<script>
const fileInput=document.getElementById('fileInput');
const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d');
const controlsBox=document.getElementById('controls');
let items=[], originals=[];

function render(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const sorted=[...items].sort((a,b)=>a.z-b.z);
  for(const it of sorted) ctx.drawImage(it.img,it.x,it.y);
}

async function loadImages(files){
  const imgs=[];
  for(const f of files){
    if(!f.type.startsWith('image/'))continue;
    const img=new Image(); img.src=URL.createObjectURL(f);
    await new Promise(r=>img.onload=r);
    imgs.push({name:f.name,img});
  }
  if(!imgs.length)return;
  const maxW=Math.max(...imgs.map(i=>i.img.width));
  const totalH=imgs.reduce((a,b)=>a+b.img.height,0);
  canvas.width=maxW;canvas.height=totalH;
  let y=0;
  const newItems=imgs.map((o,i)=>{
    const it={name:o.name,img:o.img,x:(maxW-o.img.width)/2,y,z:items.length+i};
    y+=o.img.height;
    return it;
  });
  items=items.concat(newItems);
  originals=items.map(i=>({...i}));
  refreshControls(); render();
}

function refreshControls(){
  controlsBox.innerHTML='';
  if(!items.length)return;
  const maxW=Math.max(...items.map(i=>i.img.width));
  items.forEach((it,i)=>addItemControl(it,i,it.img.width===maxW));
}

function addItemControl(item,idx,isMax){
  const div=document.createElement('div');
  div.className='itemCtrl'+(isMax?' maxItem':'');
  div.innerHTML=`
    <div class="itemHeader">
      <span>${item.name}</span>
      <button class="removeBtn">Ã—</button>
    </div>
    ${!isMax?`
      X:<input type="range" min="0" max="${canvas.width}" value="${item.x}" id="xr${idx}">
      <input type="number" value="${item.x}" id="xn${idx}">
    `:`<span>(X locked)</span>`}
    Y:<input type="range" min="0" max="${canvas.height}" value="${item.y}" id="yr${idx}">
    <input type="number" value="${item.y}" id="yn${idx}">
    <label>Layer:
      <select class="layerSelect" id="z${idx}">
        ${items.map((_,i)=>`<option value="${i}" ${i===item.z?'selected':''}>${i}</option>`).join('')}
      </select>
    </label>
  `;
  controlsBox.appendChild(div);

  const xr=div.querySelector(`#xr${idx}`),
        xn=div.querySelector(`#xn${idx}`),
        yr=div.querySelector(`#yr${idx}`),
        yn=div.querySelector(`#yn${idx}`),
        zSel=div.querySelector(`#z${idx}`),
        rm=div.querySelector('.removeBtn');

  const updateX=v=>{item.x=+v;if(xr)xr.value=xn.value=v;render();}
  const updateY=v=>{item.y=+v;yr.value=yn.value=v;render();}
  const updateZ=v=>{item.z=+v;render();refreshControls();}
  if(!isMax){xr.oninput=e=>updateX(e.target.value);xn.oninput=e=>updateX(e.target.value);}
  yr.oninput=e=>updateY(e.target.value);yn.oninput=e=>updateY(e.target.value);
  zSel.onchange=e=>updateZ(e.target.value);
  rm.onclick=()=>{items=items.filter(i=>i!==item);originals=originals.filter(o=>o.name!==item.name);refreshControls();render();}
}

document.getElementById('autoTrim').onclick=()=>{
  const w=canvas.width,h=canvas.height;
  const d=ctx.getImageData(0,0,w,h).data;
  let top=h,left=w,right=0,bottom=0,found=false;
  for(let y=0;y<h;y++)for(let x=0;x<w;x++){const a=d[(y*w+x)*4+3];
    if(a>0){found=true;if(x<left)left=x;if(x>right)right=x;if(y<top)top=y;if(y>bottom)bottom=y;}
  }
  if(!found)return alert('KhÃ´ng tÃ¬m tháº¥y pixel nÃ o!');
  const trimW=right-left+1,trimH=bottom-top+1;
  const imgData=ctx.getImageData(left,top,trimW,trimH);
  canvas.width=trimW;canvas.height=trimH;ctx.putImageData(imgData,0,0);
  items.forEach(it=>{it.x-=left;it.y-=top;});render();
};

document.getElementById('refresh').onclick=()=>{
  if(!originals.length)return;
  const maxW=Math.max(...originals.map(i=>i.img.width));
  const totalH=originals.reduce((a,b)=>a+b.img.height,0);
  canvas.width=maxW;canvas.height=totalH;
  items=originals.map(o=>({...o}));
  refreshControls(); render();
};

document.getElementById('download').onclick=()=>{
  canvas.toBlob(b=>{
    const a=document.createElement('a');
    a.href=URL.createObjectURL(b);
    a.download='sprite_edit.png';
    a.click(); URL.revokeObjectURL(a.href);
  });
};

fileInput.onchange=e=>loadImages(e.target.files);
</script>
</body>
</html>
