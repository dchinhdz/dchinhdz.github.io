<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sprite Maker</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<header>🧱 Sprite Maker</header>
<main>
  <input type="file" id="fileInput" multiple accept="image/*">
  <div id="canvasWrap"><canvas id="canvas"></canvas></div>
  <div class="controls-top">
    <button id="build">Tạo Sprite + JSON</button>
  </div>
  <pre id="jsonOutput"></pre>
</main>

<script>
const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d');
const out=document.getElementById('jsonOutput');
let files=[];

document.getElementById('fileInput').onchange=e=>{
  files=[...e.target.files].filter(f=>f.type.startsWith('image/'));
};

document.getElementById('build').onclick=async()=>{
  if(!files.length)return alert('Chưa chọn ảnh!');
  const imgs=[];
  for(const f of files){
    const img=new Image();
    img.src=URL.createObjectURL(f);
    await new Promise(r=>img.onload=r);
    imgs.push({name:f.name,img});
  }

  const maxW=Math.max(...imgs.map(i=>i.img.width));
  const totalH=imgs.reduce((a,b)=>a+b.img.height,0);
  canvas.width=maxW;canvas.height=totalH;
  ctx.clearRect(0,0,maxW,totalH);

  let y=0, items={}, total=imgs.length;
  for(const o of imgs){
    const x=(maxW-o.img.width)/2;
    ctx.drawImage(o.img,x,y);
    items[o.name.replace(/\.[^.]+$/,'')]=[x,y,o.img.width,o.img.height];
    y+=o.img.height;
  }

  const id=Math.floor(1000+Math.random()*9000);
  const info={image:`sprite_${id}.png`,width:maxW,height:totalH,count:total};
  const json={info,items};
  out.textContent=JSON.stringify(json,null,2);

  canvas.toBlob(b=>{
    const a=document.createElement('a');
    a.href=URL.createObjectURL(b);
    a.download=`sprite_${id}.png`;
    a.click();
  });

  const blob=new Blob([JSON.stringify(json,null,2)],{type:'application/json'});
  const link=document.createElement('a');
  link.href=URL.createObjectURL(blob);
  link.download=`sprite_${id}.json`;
  link.click();
};
</script>
</body>
</html>
