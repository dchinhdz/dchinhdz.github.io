<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sprite Sheet Generator</title>
<style>
  body {
    font-family: system-ui, sans-serif;
    margin: 20px;
    background: #fafafa;
  }
  input, button {
    margin: 10px 5px 10px 0;
    padding: 6px 10px;
    cursor: pointer;
  }
  #preview {
    margin-top: 20px;
    border: 1px solid #ccc;
    display: block;
    max-width: 100%;
  }
  #jsonOutput {
    margin-top: 20px;
    white-space: pre-wrap;
    background: #eee;
    padding: 10px;
    border-radius: 5px;
    max-height: 300px;
    overflow: auto;
  }
</style>
</head>
<body>

<h1>Sprite Sheet Generator</h1>

<input type="file" id="fileInput" multiple accept="image/*">
<br>
<button id="downloadImage">Download Sprite Sheet PNG</button>
<button id="downloadJSON">Download JSON</button>

<canvas id="preview"></canvas>
<pre id="jsonOutput"></pre>

<script>
const fileInput = document.getElementById('fileInput');
const previewCanvas = document.getElementById('preview');
const ctx = previewCanvas.getContext('2d');
const jsonOutput = document.getElementById('jsonOutput');

let spriteData = {};
let spriteBlob = null;
let spriteName = "";

// Tạo tên ngẫu nhiên
function randomName() {
  const n = Math.floor(1000 + Math.random() * 9000);
  return `sprite_${n}`;
}

// Chuyển canvas -> Blob
function canvasToBlob(canvas) {
  return new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
}

// Tạo sprite sheet
async function generateSprite(files) {
  if (!files.length) return;

  const images = [];
  for (const file of files) {
    if (!file.type.startsWith('image/')) continue;
    const img = new Image();
    img.src = URL.createObjectURL(file);
    await new Promise(res => img.onload = res);
    images.push({ name: file.name, img });
  }

  if (!images.length) return;

  const maxWidth = Math.max(...images.map(i => i.img.width));
  const totalHeight = images.reduce((sum, i) => sum + i.img.height, 0);

  previewCanvas.width = maxWidth;
  previewCanvas.height = totalHeight;
  ctx.clearRect(0, 0, maxWidth, totalHeight);

  let y = 0;
  const items = {};

  for (const { name, img } of images) {
    const x = (maxWidth - img.width) / 2;
    ctx.drawImage(img, x, y);

    const cleanName = name.replace(/\.[^/.]+$/, ""); // bỏ đuôi .png, .jpg,...
    items[cleanName] = [Math.round(x), Math.round(y), img.width, img.height];
    y += img.height;
  }

  spriteName = randomName();

  spriteData = {
    info: {
      filename: `${spriteName}.png`,
      width: maxWidth,
      height: totalHeight,
      total_items: images.length
    },
    items
  };

  jsonOutput.textContent = JSON.stringify(spriteData, null, 2);
  spriteBlob = await canvasToBlob(previewCanvas);
}

// Sự kiện upload
fileInput.addEventListener('change', e => generateSprite(e.target.files));

// Download PNG
document.getElementById('downloadImage').addEventListener('click', () => {
  if (!spriteBlob) return alert('⚠️ Hãy upload ảnh trước khi tải!');
  const url = URL.createObjectURL(spriteBlob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${spriteName}.png`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
});

// Download JSON
document.getElementById('downloadJSON').addEventListener('click', () => {
  if (!Object.keys(spriteData).length) return alert('⚠️ Chưa có JSON dữ liệu.');
  const blob = new Blob([JSON.stringify(spriteData, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${spriteName}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
});
</script>

</body>
</html>
